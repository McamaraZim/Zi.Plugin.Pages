@model Nop.Plugin.Zimaltec.CustomPages.Components.TopicTemplateFlagModel
@using System.Text.RegularExpressions
@using System.Linq
@inject IGenericAttributeService GenericAttributeService
@inject IWorkContext WorkContext

@{
    // Persistencia de “colapsado/expandido” del bloque
    const string hideBlockAttributeName = "TopicPage.HideCustomPagesTemplateBlock";
    var customer = await WorkContext.GetCurrentCustomerAsync();
    var hideBlock = await GenericAttributeService.GetAttributeAsync<bool>(customer, hideBlockAttributeName, defaultValue: false);
}

<nop-card asp-name="topic-custompages-template"
          asp-icon="far fa-copy"
          asp-title="Plantilla de Custom Pages"
          asp-hide-block-attribute-name="@hideBlockAttributeName"
          asp-hide="@hideBlock"
          asp-advanced="false">
    <div class="card-body">
        <div class="form-group">
            <label>
                <input type="checkbox"
                       id="cp-isTemplate"
                       name="cp-isTemplate"
                       value="true"
                       @(Model.IsTemplate ? "checked" : "")/>
                Marcar Topic como plantilla
            </label>
            <div class="text-muted small">
                Usa placeholders <code>{{clave}}</code> dentro del HTML. Ej.: <code>{{imagen_principal}}</code>
            </div>
        </div>

        @{
            var rx = new Regex(@"{{\s*([^:{}|]+?)\s*}}", RegexOptions.IgnoreCase);

            List<string> keys;
            if (!string.IsNullOrWhiteSpace(Model.Body))
            {
                keys = rx.Matches(Model.Body)
                    .Select(m => m.Groups[1].Value.Trim())
                    .Where(s => !string.IsNullOrWhiteSpace(s))
                    .Distinct(StringComparer.InvariantCultureIgnoreCase)
                    .OrderBy(x => x)
                    .ToList();
            }
            else
            {
                keys = new List<string>();
            }
        }
        @if (keys.Any())
        {
            <div class="alert alert-info">
                <strong>Detectados:</strong> @string.Join(", ", keys)
            </div>
        }
    </div>
</nop-card>
